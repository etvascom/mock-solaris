{% extends 'layout.html' %}

{% block content %}

<ul class="nav nav-tabs">
  <li role="presentation"><a href="/__BACKOFFICE__/">â¬… Persons</a></li>
  <li role="presentation"><a href="/__BACKOFFICE__/person/{{ person.email }}">user</a></li>
  <li role="presentation" class="active"><a href="#">cards</a></li>
</ul>

<div class="page-header">
  <h2>{{ person.email }}</h2>
</div>

<div class="col-md-12">
  <div class="panel panel-default">
    <div class="panel-heading">Existing cards</div>
    {% for cardData in person.account.cards %}
    <table class="table">
      <thead>
        <tr>
          <th>Number</th>
          <th>Type</th>
          <th>Details<th>
        </tr>
      </thead>
      <tbody>
        <td>{{ cardData.cardDetails.cardNumber }}</td>
        <td>{{ cardData.card.type }}</td>
        <td style="display: flex; flex-direction: row;">
          <table class="table">
            <tr>
              <td>Status <b>{{ cardData.card.status }}</b></td>
              <td>
                <form class="form-inline autosubmitonchange" method="POST" action="/__BACKOFFICE__/changeCardStatus">
                  <select name="status">
                    <option {% if cardData.card.status==="BLOCKED_BY_SOLARIS" %}selected {% endif %}value="BLOCKED_BY_SOLARIS">BLOCKED_BY_SOLARIS</option>
                    <option {% if cardData.card.status==="ACTIVATION_BLOCKED_BY_SOLARIS" %}selected {% endif %}value="ACTIVATION_BLOCKED_BY_SOLARIS">ACTIVATION_BLOCKED_BY_SOLARIS</option>
                    <option {% if cardData.card.status==="CLOSED_BY_SOLARIS" %}selected {% endif %}value="CLOSED_BY_SOLARIS">CLOSED_BY_SOLARIS</option>
                    <option {% if cardData.card.status==="ACTIVE" %}selected {% endif %}value="ACTIVE">ACTIVE</option>
                  </select>
                  <input type="hidden" name="personId" value={{ person.id }}>
                  <input type="hidden" name="accountId" value={{ person.account.id }}>
                  <input type="hidden" name="cardId" value={{ cardData.card.id }}>
                </form>
              </td>
            </tr>
            <tr>
              <td>card id</td>
              <td>{{ cardData.card.id }}</td>
            </tr>
            <tr>
              <td>token</td>
              <td>{{ cardData.cardDetails.token }}</td>
            </tr>
            <tr>
              <td>expiration date</td>
              <td>{{ cardData.card.expiration_date }}</td>
            </tr>
            <tr>
              <td>holder</td>
              <td>{{ cardData.card.representation.line_1 }}</td>
            </tr>
          </table>
        </td>
      </tbody>
    </table>
    {% endfor %}
  </div>
</div>

{% if person.account.cards[0] %}
<div class="col-md-5">
  <div class="panel panel-default">
    <div class="panel-heading">Use card</div>
    <div class="panel-body">
      <form id="createReservation" method="POST" action="/__BACKOFFICE__/person/{{ person.id }}/reservations">
        <div class="custom-controls-stacked">
          <div class="form-group">
            {% for cardData in person.account.cards %}
            <div class="radio">
              <label>
                <input checked type="radio" name="cardId" value="{{ cardData.card.id }}">
                <b>
                  {{ cardData.card['type'] }}
                </b>
                ({{ cardData.cardDetails.cardNumber }})
                ({{ cardData.card.status }})
              </label>
            </div>
            {% endfor %}
          </div>

          <fieldset>
            <div class="form-group">
              <label class="col-form-label" for="status">Status</label>
              <select class="form-control" name="status">
                <option selected="selected" value="OPEN">OPEN</option>
                <option value="REJECTED">REJECTED</option>
              </select>
            </div>

            <div class="form-group">
              <label class="col-form-label" for="type">Type</label>
              <select class="form-control" name="type">
                <option value="PURCHASE">PURCHASE</option>
                <option value="CASH_ATM">CASH_ATM</option>
                <option value="CASH_MANUAL">CASH_MANUAL</option>
                <option value="CREDIT_PRESENTMENT">CREDIT_PRESENTMENT</option>
              </select>
            </div>

            <div class="form-group">
              <label class="col-form-label" for="amount">Amount (in cents)</label>
              <input class="form-control" type="number" name="amount" placeholder="100" autocomplete="off" required/>
            </div>

            <div class="form-group">
              <label class="col-form-label" for="amount">Currency</label>
              <select class="form-control" name="currency">
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
              </select>
            </div>

            <div class="form-group">
              <label class="col-form-label" for="recipient">Recipient</label>
              <input class="form-control" type="text" name="recipient" value="Willy Wonka" required/>
            </div>

            <div class="slideunlock-wrapper">
              <button type="submit" class="btn btn-primary btn-block">
                <span>Tap to pay</span>
              </button>
            </div>
          </fieldset>
      </form>
    </div>
  </div>
</div>
</div>

<div class="col-md-7">
  <div class="panel panel-default">
    <div class="panel-heading">Open reservations</div>

    <div class="vertical-scroll">
      <table class="table">
        <thead>
          <tr>
            <th>type</th>
            <th>action</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Recipient</th>
          </tr>
        </thead>
        {% for reservation in person.account.reservations %}
        <tr>
          <td>{{ (JSON.parse(reservation.meta_info)).cards.transaction_type }}</td>
          <td>
            <form id="updateReservation" action="/__BACKOFFICE__/person/{{ person.id }}/reservations/{{ reservation.id }}"
              method="POST">
              <div class="form-group">
                <select name="action">
                  <option selected="selected" value="BOOK">BOOK</option>
                  <option value="CANCEL">CANCEL</option>
                  <option value="EXPIRE">EXPIRE</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">Update now</button>
            </form>
          </td>
          <td>{{ (JSON.parse(reservation.meta_info)).cards.transaction_date }}</td>
          <td>{{ (reservation.amount.value / 100).toFixed(2) }} {{ reservation.amount.currency }}</td>
          <td>{{ reservation.description }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>
  </div>
</div>

<div class="col-md-12">
  <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
    <div class="panel panel-default">
      <div class="panel-heading" role="tab" id="headingOne">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true"
            aria-controls="collapseOne">
            Raw person data
          </a>
          <span class="caret"></span>
        </h4>
      </div>
      <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
        <div class="panel-body">
          <pre>{{ JSON.stringify(person, undefined, 2) }}</pre>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
  $(".autosubmitonchange").change(function() {
    this.submit();
  });
</script>

{% endblock %}
